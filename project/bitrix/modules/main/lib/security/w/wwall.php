<? namespace Bitrix\Main\Security\W;$GLOBALS['____1742812636']= array(base64_decode('dGltZ'.'Q=='),base64_decode('dGlt'.'ZQ=='),base64_decode('anNvbl9'.'k'.'ZWNv'.'Z'.'GU='),base64_decode('Y'.'XJyYXlf'.'bWV'.'yZ2U='),base64_decode('a'.'m9pb'.'g='.'='),base64_decode(''.'am'.'9pb'.'g='.'='),base64_decode(''.'am9pb'.'g=='),base64_decode('YXJ'.'yY'.'X'.'l'.'fc'.'G9w'),base64_decode('YXJ'.'yY'.'Xlfc'.'2hpZ'.'nQ='),base64_decode('Y'.'XJy'.'YXlfc2hpZ'.'n'.'Q='),base64_decode(''.'YXJyYXlfc2'.'h'.'pZ'.'nQ='),base64_decode('Y'.'XJy'.'YXl'.'fc2hpZ'.'nQ='),base64_decode(''.'YXJ'.'yY'.'X'.'lfbW'.'VyZ2U'.'='),base64_decode('aXNf'.'YXJ'.'yYXk='),base64_decode('Y'.'X'.'J'.'yYXlfbWVyZ'.'2U'.'='),base64_decode('aW5f'.'YXJ'.'yYXk='),base64_decode('aW5fY'.'XJy'.'YXk='),base64_decode(''.'aW5'.'fY'.'XJyYXk='),base64_decode('aW5f'.'Y'.'XJyYXk='),base64_decode('a'.'W5'.'fYXJyYXk='),base64_decode(''.'dG'.'ltZQ=='),base64_decode('dGltZQ'.'=='),base64_decode('YXJyY'.'XlfbWFw'),base64_decode(''.'Z2V0X2'.'xvYWRlZ'.'F9leHRl'.'b'.'nNpb2'.'5z'),base64_decode('anNvbl9lb'.'mNvZ'.'GU='),base64_decode('anN'.'vbl9lb'.'mNvZG'.'U='),base64_decode('cG'.'h'.'wdmV'.'yc2'.'lv'.'bg=='),base64_decode('a'.'nN'.'vbl'.'9'.'lbmN'.'vZGU='),base64_decode(''.'am9pbg='.'='));if(!function_exists(__NAMESPACE__.'\\___1940549337')){function ___1940549337($_1823852587){static $_807420722= false; if($_807420722 == false) $_807420722=array(''.'V'.'1'.'dB'.'TE'.'xfTE9'.'D'.'Sw'.'==','c'.'2Vj'.'dXJpdHk'.'=','REFUQQ==','eyI=','V'.'1dBTEx'.'fTE9'.'DSw==',''.'c2'.'V'.'jdXJpdHk=','U0VD'.'VVJJV'.'F'.'lfV1'.'dBTE'.'xfRVhDRVB'.'USU'.'9O','R'.'kFJT'.'F9'.'DS'.'EV'.'DS'.'0'.'l'.'ORw==','Q2FuIG5vdCBle'.'G'.'Vjd'.'XR'.'l'.'IHd'.'3YWxsI'.'HJ1bGVz'.'OiA=','I'.'FRyYWNlOiA=','UkVRVUV'.'TVF9VUkk=','a2V5'.'c'.'w==','dmFsdWVz','U0VDVVJJVFl'.'fV1dBTExfTU9ESUZZ','L'.'g==','U0'.'VDVVJJVFlf'.'V'.'1'.'dBT'.'Ex'.'fVU'.'5TRVQ=','Lg==','U0VDVVJJVFlf'.'V'.'1dBTExfRVhJVA==',''.'Lg==','Z2xvYm'.'Fs',''.'a2V5c'.'w==','dmFsdWVz','Z2V0','Z2V0','cG9zdA='.'=',''.'cG9'.'zdA==',''.'Y29va2ll','Y2'.'9va2'.'l'.'l','cm'.'VxdWVzdA'.'==','cmVxdWVzdA'.'==','Z'.'2'.'xv'.'YmFs',''.'Z'.'2'.'xvYmFs',''.'bWFpbl9zZWM=','V1dBTEx'.'f'.'QUNUVUFM'.'SV'.'pFX1J'.'VTE'.'VT','d'.'g='.'=','dmVyc'.'2lvbg='.'=','aQ==','aX'.'N'.'JbnN'.'0YWxsZWQ=','dg==','a'.'W'.'5p',''.'bW9k'.'dWx'.'lcw'.'==','bG'.'l'.'j'.'Z'.'W'.'5z'.'ZQ==','c'.'Gh'.'w',''.'dg==','ZXh0','c2'.'VjdXJ'.'pdHk=',''.'ZG'.'I=','d'.'HlwZQ==','ZGI=','dmVy'.'c2lvbg==','ZGI=','dHlwZQ'.'==','ZGI'.'=','dHlwZQ==','dmVyc2lvbg'.'==','ZGI=','dmV'.'yc2'.'lvbg==',''.'ZW52aXJv'.'bm1lb'.'nQ=','d'.'m1f'.'dmVyc2lv'.'bg==','dm0=','dg==','ZW52aXJvbm'.'1lbnQ=','dm1fdmVyc2l'.'vbg='.'=','c29ja2V0VGltZW91d'.'A='.'=',''.'c3'.'R'.'y'.'ZWF'.'tVG'.'l'.'t'.'ZW9'.'1dA='.'=','KCc=','ZGF'.'0YQ='.'=','Jywg'.'Jw==','b'.'W9kdWxl','JywgJw='.'=','bW9kd'.'Wxl'.'X3ZlcnNpb24=','Jyk=','LCA=',''.'U0VDVVJJV'.'FlfV1dBTExfRV'.'hDR'.'V'.'BU'.'SU'.'9O','bWF'.'pbg==','RkFJTF9SRUZSR'.'VNISU'.'5H','Q2FuIG'.'5vdCB'.'yZWZy'.'ZXNoIHd3YW'.'xs'.'IHJ1bGVz'.'OiA=','IF'.'Ry'.'YWNlO'.'iA=','Z'.'GF0YQ==','eyI=',''.'LS'.'0tLS1CRUdJT'.'i'.'BQ'.'VUJMSUMgS0V'.'ZLS0t'.'LS0=','Ck1JSU'.'JJakFOQ'.'m'.'drcWhraU'.'c5dzBCQVFFRkFBT'.'0NBUT'.'h'.'BTU'.'l'.'J'.'QkNnS0NBUUVBcThRRTBIam1I'.'SlVT'.'dF'.'dWNm'.'4wemEKUlZvT'.'HgwM'.'kt6Y'.'mZ'.'y'.'YlMvUDZz'.'V2'.'F4VHp3O'.'F'.'NlR'.'1R0YlRD'.'T3JwS'.'G'.'k1UUY'.'2T1J5alovWHh6L0tMVTFHYm9mOUNaMw'.'o0ejdT'.'a3FV'.'dD'.'Y2aWJYd'.'k9GQng0Znc'.'vQVB'.'Q'.'U'.'kdEcXR'.'tMG5EM'.'2ZnR3N'.'1M'.'1JlUGd3'.'MjlpOC'.'t2b'.'T'.'dtdEJ'.'LS'.'lVZbD'.'RyC'.'lZw'.'YjZz'.'ZlpF'.'VDlL'.'RW'.'I2VDFIRFltRXZjMWhxL2'.'l'.'pdXl'.'4'.'THJaWmk1UTZ'.'VZmY0VUV2VE'.'kr'.'Njhzc0Z'.'Sa1Erb3dUUnkKZU9JTWJGaE0vVVRtZ'.'lZ'.'ZYlRSRnkyb1VRO'.'Fd'.'NemEybk'.'o1U2FoemkxVUtP'.'MWpBalhU'.'UF'.'J'.'yemM3QWp1'.'NjM5ajFPMAp'.'wcH'.'Fmb'.'TV4Z1dsRkF'.'Ka0hR'.'VGd'.'iZGQ'.'1QVdxREZ'.'R'.'a3Q'.'5SE'.'trWStUbm'.'Z'.'CT'.'E'.'dWTXZWe'.'VB'.'3'.'VE'.'hO'.'V1F'.'ZQX'.'c'.'0eH'.'BnL3'.'dBClp3'.'S'.'URBUUFC'.'Ci'.'0tLS0tRU5EIFBV'.'Q'.'kxJQy'.'B'.'LRVktLS0t'.'LQ'.'==');return base64_decode($_807420722[$_1823852587]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; private static $_310750092= 'https://wwall.bitrix.info/rules.php'; protected $_352232226= true; public function handle(){ try{  $_714175304= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_714175304)){ return;}  $_1783785138= Cache::createInstance(); $_788156049= false; if($_1783785138->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_638627837= $_1783785138->getVars(); if($GLOBALS['____1742812636'][0]()- $_638627837> round(0+5+5+5+5)){  $_1523066885= Application::getConnection(); $_1627379138= RuleRecordTable::getTableName(); $_1523066885->truncateTable($_1627379138); RuleRecordTable::cleanCache(); $_1783785138->clean(___1940549337(0), ___1940549337(1));}} elseif($_1783785138->startDataCache()){  $_1783785138->endDataCache($GLOBALS['____1742812636'][1]()); $_788156049= true;} foreach($_714175304 as $_235312922){ $_1063924426= new PublicKeyCipher; $_1201643841= $_1063924426->decrypt($_235312922[___1940549337(2)], static::__1476714576()); if(!str_starts_with($_1201643841, ___1940549337(3))){ continue;} $_1872070659= $GLOBALS['____1742812636'][2]($_1201643841, true); if(!empty($_1872070659)){ $_614092681= Rule::make($_1872070659); $_1436722664= $this->handleRule($_614092681); $this->applyHandlingResults($_1436722664);}}  if($_788156049){ $_1783785138->clean(___1940549337(4), ___1940549337(5));}} catch(\Throwable $_111576195){ $this->logEvent( ___1940549337(6), ___1940549337(7), ___1940549337(8). $_111576195->getMessage(). ___1940549337(9). $_111576195->getTraceAsString());}}  public function handleRule(Rule $_614092681): array{ $_1436722664=[]; if($_614092681->matchPath($_SERVER[___1940549337(10)])){  $_1606006949= $this->getContextElements($_614092681->getContext()); foreach($_1606006949 as $_1320180765 => &$_1546925040){ $_1436722664= $GLOBALS['____1742812636'][3]($_1436722664, $this->recursiveContextKeyHandle($_1320180765, $_1546925040,[], $_614092681));}} return $_1436722664;}  public function applyHandlingResults(array $_1436722664){ $_1606006949= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_1436722664 as $_1230700779){ $_1546925040=& $_1606006949[$_1230700779->getContextName()]; $_1655535388= $_1230700779->getRuleResult(); $_614092681= $_1230700779->getRule(); if($_1655535388 instanceof ModifyResult){ if($_614092681->getProcess() === ___1940549337(11)){  static::rewriteContextKey( $_1230700779->getContextName(), $_1546925040, $_1230700779->getContextKey(), $_1655535388->getCleanValue());} elseif($_614092681->getProcess() === ___1940549337(12)){ static::rewriteContextValue( $_1230700779->getContextName(), $_1546925040, $_1230700779->getContextKey(), $_1655535388->getCleanValue());} $this->logEvent( ___1940549337(13), $_1230700779->getContextName(), $GLOBALS['____1742812636'][4](___1940549337(14), $_1230700779->getContextKey()));} elseif($_1655535388 instanceof CheckResult &&!$_1655535388->isSuccess()){ if($_1655535388->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_1230700779->getContextName(), $_1546925040, $_1230700779->getContextKey(),); $this->logEvent( ___1940549337(15), $_1230700779->getContextName(), $GLOBALS['____1742812636'][5](___1940549337(16), $_1230700779->getContextKey()));} elseif($_1655535388->getAction() === RuleAction::EXIT){ $this->logEvent( ___1940549337(17), $_1230700779->getContextName(), $GLOBALS['____1742812636'][6](___1940549337(18), $_1230700779->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_352232226= false;} protected function rewriteContextKey($_1320180765, &$_1546925040, $_76323106, $_352762285){ $_1252008109= $_76323106;  $GLOBALS['____1742812636'][7]($_1252008109); $_1252008109[]= $_352762285; if($_1320180765 === ___1940549337(19)){ $_1486950237= $GLOBALS['____1742812636'][8]($_76323106); $GLOBALS['____1742812636'][9]($_1252008109); if(empty($_76323106)){ $GLOBALS[$_352762285]= $GLOBALS[$_1486950237]; unset($GLOBALS[$_1486950237]);} else{ $_1546925040=& $GLOBALS[$_1486950237]; $_4627980= ArrayHelper::getByNestedKey($_1546925040, $_76323106);  ArrayHelper::setByNestedKey($_1546925040, $_1252008109, $_4627980);  ArrayHelper::unsetByNestedKey($_1546925040, $_76323106);}} else{ $_4627980= ArrayHelper::getByNestedKey($_1546925040, $_76323106);  ArrayHelper::setByNestedKey($_1546925040, $_1252008109, $_4627980);  ArrayHelper::unsetByNestedKey($_1546925040, $_76323106);}} protected function rewriteContextValue($_1320180765, &$_1546925040, $_143790494, $_4627980){ if($_1320180765 === 'global'){ $_1486950237= $GLOBALS['____1742812636'][10]($_143790494); if(empty($_143790494)){ $GLOBALS[$_1486950237]= $_4627980;} else{ $_1546925040=& $GLOBALS[$_1486950237]; ArrayHelper::setByNestedKey($_1546925040, $_143790494, $_4627980);}} else{  ArrayHelper::setByNestedKey($_1546925040, $_143790494, $_4627980);}} protected function unsetContextValue($_1320180765, &$_1546925040, $_143790494){ if($_1320180765 === 'global'){ $_1486950237= $GLOBALS['____1742812636'][11]($_143790494); if(empty($_143790494)){ unset($GLOBALS[$_1486950237]);} else{ $_1546925040=& $GLOBALS[$_1486950237]; ArrayHelper::unsetByNestedKey($_1546925040, $_143790494);}} else{ ArrayHelper::unsetByNestedKey($_1546925040, $_143790494);}}  protected function recursiveContextKeyHandle(string $_1320180765, array &$_1546925040, array $_1611707072, Rule $_614092681): array{  $_1436722664=[]; foreach($_1546925040 as $_456170451 => $_4627980){ $_143790494= $GLOBALS['____1742812636'][12]($_1611707072,[$_456170451]); if($_614092681->matchKey($_143790494)){  if($_614092681->getProcess() === ___1940549337(20)){ $_1655535388= $_614092681->evaluate($_456170451);} elseif($_614092681->getProcess() === ___1940549337(21)){ $_1655535388= $_614092681->evaluateValue($_4627980);}  if(!empty($_1655535388) && $_1655535388 instanceof RuleResult){ $_1436722664[]= new HandlingResult($_1320180765, $_143790494, $_1655535388, $_614092681);}}  if($GLOBALS['____1742812636'][13]($_4627980)){ $_1436722664= $GLOBALS['____1742812636'][14]($_1436722664, $this->recursiveContextKeyHandle( $_1320180765, $_1546925040[$_456170451], $_143790494, $_614092681));}} return $_1436722664;} protected function getContextElements(array $_533552298){ $_381199752=[]; if($GLOBALS['____1742812636'][15](___1940549337(22), $_533552298, true)){ $_381199752[___1940549337(23)]= &$_GET;} if($GLOBALS['____1742812636'][16](___1940549337(24), $_533552298, true)){ $_381199752[___1940549337(25)]= &$_POST;} if($GLOBALS['____1742812636'][17](___1940549337(26), $_533552298, true)){ $_381199752[___1940549337(27)]= &$_COOKIE;} if($GLOBALS['____1742812636'][18](___1940549337(28), $_533552298, true)){ $_381199752[___1940549337(29)]= &$_REQUEST;} if($GLOBALS['____1742812636'][19](___1940549337(30), $_533552298, true)){ $_381199752[___1940549337(31)]= $GLOBALS;} return $_381199752;} public static function refreshRules(){ try{ $_1333301598= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____1742812636'][20]()- $_1333301598)< static::CACHE_RULES_TTL){ return;} Option::set(___1940549337(32), ___1940549337(33), $GLOBALS['____1742812636'][21]()); $_1246965730= null;  $_2024374858= $GLOBALS['____1742812636'][22](function($_2133834513){ return[___1940549337(34) => $_2133834513[___1940549337(35)], ___1940549337(36) => (int) $_2133834513[___1940549337(37)]];}, ModuleManager::getModulesFromDisk());  $_1511852750=[]; foreach($GLOBALS['____1742812636'][23]() as $_1356049956){ $_228924155= new ReflectionExtension($_1356049956); $_1511852750[$_1356049956]=[ ___1940549337(38) => $_228924155->getVersion(), ___1940549337(39) => $_228924155->getINIEntries()];} $_1875732237=[ ___1940549337(40) => $GLOBALS['____1742812636'][24]($_2024374858), ___1940549337(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___1940549337(42) => $GLOBALS['____1742812636'][25]([ ___1940549337(43) => $GLOBALS['____1742812636'][26](), ___1940549337(44) => $_1511852750])]; if(Loader::includeModule(___1940549337(45))){ $_1213608275= CSecuritySystemInformation::getSystemInformation(); if(isset($_1213608275[___1940549337(46)][___1940549337(47)]) && isset($_1213608275[___1940549337(48)][___1940549337(49)])){ $_1875732237[___1940549337(50)]=[ ___1940549337(51) => $_1213608275[___1940549337(52)][___1940549337(53)], ___1940549337(54) => $_1213608275[___1940549337(55)][___1940549337(56)]];} if(isset($_1213608275[___1940549337(57)][___1940549337(58)])){ $_1875732237[___1940549337(59)]=[___1940549337(60) => $_1213608275[___1940549337(61)][___1940549337(62)]];}}  $_845296097= new HttpClient([ ___1940549337(63) => round(0+2.5+2.5), ___1940549337(64) => round(0+1.25+1.25+1.25+1.25)]); $_1439738377= $_845296097->post( static::$_310750092, $_1875732237); if($_845296097->getStatus() == round(0+40+40+40+40+40) &&!empty($_1439738377)){ $_1246965730= Json::decode($_1439738377);}  if($_1246965730 !== null){ $_1523066885= Application::getConnection(); $_1627379138= RuleRecordTable::getTableName(); if(!empty($_1246965730)){ foreach($_1246965730 as $_1640797093){ if(!static::checkRuleSign($_1640797093)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____1742812636'][27]($_1640797093));}}}  $_1523066885->truncateTable($_1627379138);  if(!empty($_1246965730)){ $_1123528218=[]; foreach($_1246965730 as $_1640797093){ $_1123528218[]= ___1940549337(65). $_1523066885->getSqlHelper()->forSql($_1640797093[___1940549337(66)]). ___1940549337(67). $_1523066885->getSqlHelper()->forSql($_1640797093[___1940549337(68)]). ___1940549337(69). $_1523066885->getSqlHelper()->forSql($_1640797093[___1940549337(70)]). ___1940549337(71);} $_1409540591= $GLOBALS['____1742812636'][28](___1940549337(72), $_1123528218);  $_1523066885->query("INSERT INTO {$_1627379138} (DATA, MODULE, MODULE_VERSION) VALUES {$_1409540591}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_111576195){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___1940549337(73), ___1940549337(74), ___1940549337(75), ___1940549337(76). $_111576195->getMessage(). ___1940549337(77). $_111576195->getTraceAsString());}} protected static function checkRuleSign($_614092681){ $_1063924426= new PublicKeyCipher; $_1872070659= $_1063924426->decrypt($_614092681[___1940549337(78)], static::__1476714576()); return str_starts_with($_1872070659, ___1940549337(79));} private static function __1476714576(){ $_1827831572= ''; $_1827831572 .= ___1940549337(80); $_1827831572 .= ___1940549337(81); return $_1827831572;} protected function logEvent($_163262843, $_426760695, $_637139599){ if($this->_352232226){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_163262843, 'main', $_426760695, $_637139599);}}}?>